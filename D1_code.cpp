#include <WiFi.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <QMC5883LCompass.h>
#include <BLEDevice.h>
#include <BLEUtils.h>
#include <BLEScan.h>
#include <BLEAdvertisedDevice.h>

#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

QMC5883LCompass compass;
BLEScan* pBLEScan;

const char* ssid = "Mani";
const char* password = "12345678";
const float REF_RSSI = -54.0;
const int PATH_LOSS = 3;
const int sosPin = 14;
const int motorPin = 26;

// --- Add LOGO and ARROW bitmaps here (see canvas) ---
extern const unsigned char LOGOUntitled_design__1_[] = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xf8, 0x1f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xc0, 0x03, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x78, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0xfc, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0xfc, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0xfc, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x7c, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x38, 0x38, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x7c, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x7c, 0xfe, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x7d, 0xff, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x3b, 0xff, 0x8c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x01, 0xff, 0x98, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x7c, 0xfd, 0x98, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0xfe, 0xfd, 0x98, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x19, 0xfe, 0xfd, 0x98, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0d, 0xfe, 0xfd, 0xb0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0d, 0xfe, 0xfd, 0xb0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfa, 0xfd, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfa, 0xfc, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xfa, 0xfc, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xfa, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfa, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3c, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xe7, 0xe7, 0xe2, 0x33, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x26, 0x66, 0x32, 0x33, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x06, 0x6c, 0x12, 0x32, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0xf7, 0xec, 0x12, 0x33, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x37, 0xcc, 0x32, 0x33, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x36, 0xc6, 0x33, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xe6, 0x67, 0xe3, 0xe3, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x01, 0x80, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xf3, 0x10, 0xc3, 0xe7, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x33, 0x11, 0xc2, 0x26, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x03, 0x11, 0x62, 0x36, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x7b, 0x13, 0x23, 0xe6, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x7b, 0x13, 0xf3, 0xc6, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x13, 0x33, 0xf2, 0x66, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xf3, 0xf6, 0x12, 0x67, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xc0, 0xc4, 0x12, 0x27, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

extern const unsigned char epd_bitmap_up[]= {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x03, 0xc0, 0x00, 0x00, 0x07, 0xe0, 0x00, 
	0x00, 0x0f, 0xf0, 0x00, 0x00, 0x1f, 0xf8, 0x00, 0x00, 0x3f, 0xfc, 0x00, 0x00, 0x7f, 0xfe, 0x00, 
	0x00, 0xff, 0xff, 0x00, 0x01, 0xff, 0xff, 0x80, 0x03, 0xff, 0xff, 0xc0, 0x07, 0xff, 0xff, 0xe0, 
	0x0f, 0xff, 0xff, 0xf0, 0x1f, 0xff, 0xff, 0xf8, 0x3f, 0xff, 0xff, 0xfc, 0x00, 0x7f, 0xfe, 0x00, 
	0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xfe, 0x00, 
	0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xfe, 0x00, 
	0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xfe, 0x00, 
	0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xfe, 0x00
};

extern const unsigned char epd_bitmap_down[]= {
	0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xfe, 0x00, 
	0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xfe, 0x00, 
	0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xfe, 0x00, 
	0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x3f, 0xff, 0xff, 0xfc, 
	0x1f, 0xff, 0xff, 0xf8, 0x0f, 0xff, 0xff, 0xf0, 0x07, 0xff, 0xff, 0xe0, 0x03, 0xff, 0xff, 0xc0, 
	0x01, 0xff, 0xff, 0x80, 0x00, 0xff, 0xff, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00, 0x3f, 0xfc, 0x00, 
	0x00, 0x1f, 0xf8, 0x00, 0x00, 0x0f, 0xf0, 0x00, 0x00, 0x07, 0xe0, 0x00, 0x00, 0x03, 0xc0, 0x00, 
	0x00, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00
};

extern const unsigned char epd_bitmap_left[]= {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 
	0x00, 0x0f, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 0x7f, 0x00, 0x00, 
	0x00, 0xff, 0xff, 0xfe, 0x01, 0xff, 0xff, 0xfe, 0x03, 0xff, 0xff, 0xfe, 0x07, 0xff, 0xff, 0xfe, 
	0x0f, 0xff, 0xff, 0xfe, 0x1f, 0xff, 0xff, 0xfe, 0x3f, 0xff, 0xff, 0xfe, 0x3f, 0xff, 0xff, 0xfe, 
	0x1f, 0xff, 0xff, 0xfe, 0x0f, 0xff, 0xff, 0xfe, 0x07, 0xff, 0xff, 0xfe, 0x03, 0xff, 0xff, 0xfe, 
	0x01, 0xff, 0xff, 0xfe, 0x00, 0xff, 0xff, 0xfe, 0x00, 0x7f, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 
	0x00, 0x1f, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 
	0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

extern const unsigned char epd_bitmap_right[] = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x00, 0xe0, 0x00, 
	0x00, 0x00, 0xf0, 0x00, 0x00, 0x00, 0xf8, 0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0xfe, 0x00, 
	0x7f, 0xff, 0xff, 0x00, 0x7f, 0xff, 0xff, 0x80, 0x7f, 0xff, 0xff, 0xc0, 0x7f, 0xff, 0xff, 0xe0, 
	0x7f, 0xff, 0xff, 0xf0, 0x7f, 0xff, 0xff, 0xf8, 0x7f, 0xff, 0xff, 0xfc, 0x7f, 0xff, 0xff, 0xfc, 
	0x7f, 0xff, 0xff, 0xf8, 0x7f, 0xff, 0xff, 0xf0, 0x7f, 0xff, 0xff, 0xe0, 0x7f, 0xff, 0xff, 0xc0, 
	0x7f, 0xff, 0xff, 0x80, 0x7f, 0xff, 0xff, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x00, 0xfc, 0x00, 
	0x00, 0x00, 0xf8, 0x00, 0x00, 0x00, 0xf0, 0x00, 0x00, 0x00, 0xe0, 0x00, 0x00, 0x00, 0xc0, 0x00, 
	0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00
};

extern const unsigned char epd_bitmap_up_right[]= {
	0x0f, 0xff, 0xff, 0xfe, 0x0f, 0xff, 0xff, 0xfe, 0x0f, 0xff, 0xff, 0xfe, 0x0f, 0xff, 0xff, 0xfe, 
	0x0f, 0xff, 0xff, 0xfe, 0x0f, 0xff, 0xff, 0xfe, 0x0f, 0xff, 0xff, 0xfe, 0x0f, 0xff, 0xff, 0xfe, 
	0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00, 0xff, 0xfe, 0x00, 0x01, 0xff, 0xfe, 0x00, 0x03, 0xff, 0xfe, 
	0x00, 0x07, 0xff, 0xfe, 0x00, 0x0f, 0xff, 0xfe, 0x00, 0x1f, 0xfd, 0xfe, 0x00, 0x3f, 0xf9, 0xfe, 
	0x00, 0x7f, 0xf1, 0xfe, 0x00, 0xff, 0xe1, 0xfe, 0x01, 0xff, 0xc1, 0xfe, 0x03, 0xff, 0x81, 0xfe, 
	0x07, 0xff, 0x01, 0xfe, 0x0f, 0xfe, 0x01, 0xfe, 0x1f, 0xfc, 0x01, 0xfe, 0x3f, 0xf8, 0x01, 0xfe, 
	0x7f, 0xf0, 0x01, 0xfe, 0x3f, 0xe0, 0x01, 0xfe, 0x1f, 0xc0, 0x01, 0xfe, 0x0f, 0x80, 0x00, 0x00, 
	0x07, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00
};

extern const unsigned char epd_bitmap_down_right[]= {
	0x02, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x0f, 0x80, 0x00, 0x00, 0x1f, 0xc0, 0x01, 0xfe, 
	0x3f, 0xe0, 0x01, 0xfe, 0x7f, 0xf0, 0x01, 0xfe, 0x3f, 0xf8, 0x01, 0xfe, 0x1f, 0xfc, 0x01, 0xfe, 
	0x0f, 0xfe, 0x01, 0xfe, 0x07, 0xff, 0x01, 0xfe, 0x03, 0xff, 0x81, 0xfe, 0x01, 0xff, 0xc1, 0xfe, 
	0x00, 0xff, 0xe1, 0xfe, 0x00, 0x7f, 0xf1, 0xfe, 0x00, 0x3f, 0xf9, 0xfe, 0x00, 0x1f, 0xfd, 0xfe, 
	0x00, 0x0f, 0xff, 0xfe, 0x00, 0x07, 0xff, 0xfe, 0x00, 0x03, 0xff, 0xfe, 0x00, 0x01, 0xff, 0xfe, 
	0x00, 0x00, 0xff, 0xfe, 0x00, 0x00, 0x7f, 0xfe, 0x0f, 0xff, 0xff, 0xfe, 0x0f, 0xff, 0xff, 0xfe, 
	0x0f, 0xff, 0xff, 0xfe, 0x0f, 0xff, 0xff, 0xfe, 0x0f, 0xff, 0xff, 0xfe, 0x0f, 0xff, 0xff, 0xfe, 
	0x0f, 0xff, 0xff, 0xfe, 0x0f, 0xff, 0xff, 0xfe
};

extern const unsigned char epd_bitmap_up_left[]= {
	0x7f, 0xff, 0xff, 0xf0, 0x7f, 0xff, 0xff, 0xf0, 0x7f, 0xff, 0xff, 0xf0, 0x7f, 0xff, 0xff, 0xf0, 
	0x7f, 0xff, 0xff, 0xf0, 0x7f, 0xff, 0xff, 0xf0, 0x7f, 0xff, 0xff, 0xf0, 0x7f, 0xff, 0xff, 0xf0, 
	0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xff, 0x00, 0x00, 0x7f, 0xff, 0x80, 0x00, 0x7f, 0xff, 0xc0, 0x00, 
	0x7f, 0xff, 0xe0, 0x00, 0x7f, 0xff, 0xf0, 0x00, 0x7f, 0xbf, 0xf8, 0x00, 0x7f, 0x9f, 0xfc, 0x00, 
	0x7f, 0x8f, 0xfe, 0x00, 0x7f, 0x87, 0xff, 0x00, 0x7f, 0x83, 0xff, 0x80, 0x7f, 0x81, 0xff, 0xc0, 
	0x7f, 0x80, 0xff, 0xe0, 0x7f, 0x80, 0x7f, 0xf0, 0x7f, 0x80, 0x3f, 0xf8, 0x7f, 0x80, 0x1f, 0xfc, 
	0x7f, 0x80, 0x0f, 0xfe, 0x7f, 0x80, 0x07, 0xfc, 0x7f, 0x80, 0x03, 0xf8, 0x00, 0x00, 0x01, 0xf0, 
	0x00, 0x00, 0x00, 0xe0, 0x00, 0x00, 0x00, 0x40
};

extern const unsigned char epd_bitmap_down_left[]= {
	0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0xe0, 0x00, 0x00, 0x01, 0xf0, 0x7f, 0x80, 0x03, 0xf8, 
	0x7f, 0x80, 0x07, 0xfc, 0x7f, 0x80, 0x0f, 0xfe, 0x7f, 0x80, 0x1f, 0xfc, 0x7f, 0x80, 0x3f, 0xf8, 
	0x7f, 0x80, 0x7f, 0xf0, 0x7f, 0x80, 0xff, 0xe0, 0x7f, 0x81, 0xff, 0xc0, 0x7f, 0x83, 0xff, 0x80, 
	0x7f, 0x87, 0xff, 0x00, 0x7f, 0x8f, 0xfe, 0x00, 0x7f, 0x9f, 0xfc, 0x00, 0x7f, 0xbf, 0xf8, 0x00, 
	0x7f, 0xff, 0xf0, 0x00, 0x7f, 0xff, 0xe0, 0x00, 0x7f, 0xff, 0xc0, 0x00, 0x7f, 0xff, 0x80, 0x00, 
	0x7f, 0xff, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xf0, 0x7f, 0xff, 0xff, 0xf0, 
	0x7f, 0xff, 0xff, 0xf0, 0x7f, 0xff, 0xff, 0xf0, 0x7f, 0xff, 0xff, 0xf0, 0x7f, 0xff, 0xff, 0xf0, 
	0x7f, 0xff, 0xff, 0xf0, 0x7f, 0xff, 0xff, 0xf0
};

extern const unsigned char epd_bitmap_direction_none[] = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xf8, 0x00, 0x00, 0x3f, 0xfc, 0x00, 0x00, 0x7f, 0xfe, 0x00, 
	0x00, 0xff, 0xff, 0x00, 0x00, 0xfc, 0x3f, 0x00, 0x01, 0xf8, 0x1f, 0x00, 0x01, 0xf0, 0x1f, 0x80, 
	0x00, 0x00, 0x1f, 0x80, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 0x7f, 0x00, 
	0x00, 0x01, 0xfe, 0x00, 0x00, 0x03, 0xfc, 0x00, 0x00, 0x03, 0xf0, 0x00, 0x00, 0x07, 0xe0, 0x00, 
	0x00, 0x07, 0xc0, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00, 0x07, 0xc0, 0x00, 
	0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 
	0x00, 0x07, 0xc0, 0x00, 0x00, 0x0f, 0xc0, 0x00, 0x00, 0x0f, 0xc0, 0x00, 0x00, 0x0f, 0xc0, 0x00, 
	0x00, 0x07, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00
};


const unsigned char* getArrowBitmap(float angle) {
  if (angle >= -22.5 && angle < 22.5) return epd_bitmap_up;
  else if (angle >= 22.5 && angle < 67.5) return epd_bitmap_up_right;
  else if (angle >= 67.5 && angle < 112.5) return epd_bitmap_right;
  else if (angle >= 112.5 && angle < 157.5) return epd_bitmap_down_right;
  else if (angle >= 157.5 || angle < -157.5) return epd_bitmap_down;
  else if (angle >= -157.5 && angle < -112.5) return epd_bitmap_down_left;
  else if (angle >= -112.5 && angle < -67.5) return epd_bitmap_left;
  else if (angle >= -67.5 && angle < -22.5) return epd_bitmap_up_left;
  return epd_bitmap_direction_none;
}

struct Peer {
  String name;
  String mac;
  float rssi;
  float heading;
  bool connected;
  float distance;
};

Peer peers[] = {
  {"D2", "68:25:DD:33:B2:70"},
  {"D3", "68:25:DD:32:F0:54"}, // for D1 only
  {"D4", "00:4B:12:2F:95:7C"}  // optional
};

float calcDistance(float rssi) {
  return pow(10, (REF_RSSI - rssi) / (10.0 * PATH_LOSS));
}

float normalizeAngle(float diff) {
  diff = fmod(diff, 360);
  if (diff > 180) diff -= 360;
  else if (diff < -180) diff += 360;
  return diff;
}

void alertOutOfRange(String name, float dist) {
  display.clearDisplay();
  display.setTextSize(1);
  display.setCursor(0, 0);
  display.println(name + " out of range!");
  display.setCursor(0, 20);
  display.print("Distance: ");
  display.print(dist, 1);
  display.println(" m");
  display.display();
  digitalWrite(motorPin, HIGH);
  delay(1000);
  digitalWrite(motorPin, LOW);
}

void alertSOS() {
  display.clearDisplay();
  display.setTextSize(2);
  display.setCursor(0, 20);
  display.println("!!! SOS !!!");
  display.display();
  digitalWrite(motorPin, HIGH);
  delay(1500);
  digitalWrite(motorPin, LOW);
}

void setup() {
  Serial.begin(115200);
  Wire.begin(21, 22);
  compass.init();
  pinMode(sosPin, INPUT_PULLUP);
  pinMode(motorPin, OUTPUT);

  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println("OLED fail");
    while (true);
  }
  display.clearDisplay();
  display.drawBitmap(0, 0, LOGOUntitled_design__1_, 128, 64, SSD1306_WHITE);
  display.display();
  delay(2000);

  display.clearDisplay();
  display.setTextSize(1);
  display.setCursor(0, 0);
  display.println("Connecting WiFi...");
  display.display();

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500); Serial.print(".");
  }

  display.clearDisplay();
  display.setCursor(0, 0);
  display.print("IP: ");
  display.println(WiFi.localIP());
  display.display();

  BLEDevice::init("");
  pBLEScan = BLEDevice::getScan();
  pBLEScan->setActiveScan(true);
}

void loop() {
  for (int i = 0; i < sizeof(peers)/sizeof(peers[0]); i++) {
    BLEScanResults foundDevices = pBLEScan->start(1, false);
    peers[i].connected = false;

    for (int j = 0; j < foundDevices.getCount(); j++) {
      BLEAdvertisedDevice d = foundDevices.getDevice(j);
	  if (String(d.getAddress().toString().c_str()) == peers[i].mac) {
		peers[i].rssi = d.getRSSI();
		peers[i].distance = calcDistance(peers[i].rssi);
		peers[i].heading = compass.getAzimuth();
		peers[i].connected = true;

        float selfHeading = compass.getAzimuth();
        float diff = normalizeAngle(peers[i].heading - selfHeading);
        const unsigned char* arrow = getArrowBitmap(diff);

        display.clearDisplay();
        display.setTextSize(1);
        display.setCursor(0, 0);
        display.println(peers[i].name);
        display.setTextSize(2);
        display.setCursor(0, 20);
        display.print(peers[i].distance, 1);
        display.print(" m");
        display.drawBitmap(86, 18, arrow, 32, 30, SSD1306_WHITE);
        display.display();

        float threshold = (peers[i].name == "D1") ? 10.0 : (peers[i].name == "D2") ? 6.0 : 4.0;
        if (peers[i].distance > threshold) alertOutOfRange(peers[i].name, peers[i].distance);
        break;
      }
    }

    if (!peers[i].connected) {
      display.clearDisplay();
      display.setCursor(0, 0);
      display.println(peers[i].name + " not found");
      display.display();
    }

    if (digitalRead(sosPin) == LOW) {
      alertSOS();
    }

    delay(2000);
  }
}
